{% load static %}


{# Banner de permisos mejorado #}
<div class="mb-8">
    <div class="
        {% if not can_edit or is_readonly %}
            bg-gray-50 border-gray-200
        {% else %}
            bg-emerald-50 border-emerald-200
        {% endif %} 
        border rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow duration-300
    ">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                {% if is_readonly %}
                    <div class="flex items-center bg-gray-100 text-gray-700 font-medium px-4 py-2 rounded-lg">
                        <span class="text-xl mr-2">üîí</span>
                        <span class="text-sm font-semibold">Modo Solo Lectura</span>
                    </div>
                {% elif not can_edit %}
                    <div class="flex items-center bg-amber-100 text-amber-700 font-medium px-4 py-2 rounded-lg">
                        <span class="text-xl mr-2">‚ö†Ô∏è</span>
                        <span class="text-sm font-semibold">Sin Permisos de Edici√≥n</span>
                    </div>
                {% else %}
                    <div class="flex items-center bg-emerald-100 text-emerald-700 font-medium px-4 py-2 rounded-lg">
                        <span class="text-xl mr-2">‚úèÔ∏è</span>
                        <span class="text-sm font-semibold">Modo Edici√≥n</span>
                    </div>
                {% endif %}
            </div>

            {% if user_role %}
                <div class="
                    text-sm px-4 py-2 rounded-lg font-medium 
                    {% if can_edit and not is_readonly %}
                        bg-emerald-100 text-emerald-700 border-emerald-200
                    {% else %}
                        bg-gray-100 text-gray-600 border-gray-200
                    {% endif %} 
                    border
                ">
                    <span class="mr-1">üë§</span>
                    {{ user_role_label }}
                </div>
            {% endif %}
        </div>
        
        <div class="
            mt-3 text-sm 
            {% if can_edit and not is_readonly %}
                text-emerald-600 border-emerald-200
            {% else %}
                text-gray-500 border-gray-200
            {% endif %}
            bg-white p-3 rounded-lg border
        ">
            {% if is_readonly %}
                <p class="flex items-center">
                    <span class="mr-2">‚ÑπÔ∏è</span>
                    Esta recomendaci√≥n est√° configurada como solo lectura y no puede ser modificada.
                </p>
            {% elif not can_edit %}
                <p class="flex items-center">
                    <span class="mr-2">‚ÑπÔ∏è</span>
                    No tienes los permisos necesarios para editar esta recomendaci√≥n. Contacta a un administrador si necesitas acceso.
                </p>
            {% else %}
                <p class="flex items-center">
                    <span class="mr-2">‚ú®</span>
                    Tienes permisos para editar y modificar esta recomendaci√≥n.
                </p>
            {% endif %}
        </div>
    </div>
</div>

{# Contenedor principal mejorado #}
<div class="
    bg-white rounded-xl shadow-sm border border-gray-200 max-w-4xl 
    overflow-hidden hover:shadow-md transition-shadow duration-300
">
    {% csrf_token %}
    {{ default_recommendations|json_script:"defaultRecommendations" }}
    
    <input type="hidden" 
           id="can-edit-recommendation" 
           value="{{ can_edit|yesno:'true,false' }}"
           data-user-role="{{ user_role }}"
           data-is-readonly="{{ is_readonly|yesno:'true,false' }}">
    
    <div class="p-8 space-y-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">
            Editor de Recomendaci√≥n 
            {% if not can_edit %}
                <span class="text-sm text-gray-500 ml-2">(Modo lectura)</span>
            {% endif %}
        </h2>

        <!-- Tipo de recomendaci√≥n -->
        <div class="space-y-4">
            <div class="flex items-center space-x-4">
                <input type="radio" 
                       id="use-default"
                       name="recommendation-type" 
                       value="default"
                       {% if recommendation.use_default %}checked{% endif %}
                       {% if not can_edit %}disabled{% endif %}
                       class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                <label for="use-default" class="text-sm font-medium text-gray-700">
                    Usar recomendaci√≥n por defecto
                </label>
            </div>
            
            <div class="flex items-center space-x-4">
                <input type="radio" 
                       id="use-custom"
                       name="recommendation-type" 
                       value="custom"
                       {% if not recommendation.use_default %}checked{% endif %}
                       {% if not can_edit %}disabled{% endif %}
                       class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                <label for="use-custom" class="text-sm font-medium text-gray-700">
                    Usar recomendaci√≥n personalizada
                </label>
            </div>
        </div>

        <!-- Estado y texto -->
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <label class="text-sm font-medium text-gray-700">
                    Estado:
                </label>
                <select id="status-color" 
                        {% if not can_edit %}disabled{% endif %}
                        class="
                            ml-4 block w-48 px-4 py-2.5 text-base 
                            border-gray-300 focus:outline-none focus:ring-blue-500 
                            focus:border-blue-500 rounded-lg shadow-sm
                        ">
                    <option value="verde" {% if recommendation.status_color == 'verde' %}selected{% endif %}>
                        Verde
                    </option>
                    <option value="amarillo" {% if recommendation.status_color == 'amarillo' %}selected{% endif %}>
                        Amarillo
                    </option>
                    <option value="rojo" {% if recommendation.status_color == 'rojo' %}selected{% endif %}>
                        Rojo
                    </option>
                    <option value="gris" {% if recommendation.status_color == 'gris' %}selected{% endif %}>
                        Gris
                    </option>
                </select>
            </div>

            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">
                    Texto de la recomendaci√≥n:
                </label>
                <textarea id="recommendation-text"
                          class="
                            w-full p-4 border border-gray-300 rounded-lg shadow-sm 
                            focus:ring-blue-500 focus:border-blue-500
                            {% if not can_edit %}bg-gray-50{% endif %}
                          "
                          rows="5"
                          {% if not can_edit %}readonly{% endif %}>{{ recommendation.text }}</textarea>
            </div>
        </div>

        <!-- Opciones -->
        <div class="flex items-center space-x-6 border-t pt-6">
            <label class="inline-flex items-center space-x-3">
                <input type="checkbox" 
                       id="is-draft"
                       {% if recommendation.is_draft %}checked{% endif %}
                       {% if not can_edit %}disabled{% endif %}
                       class="
                            w-5 h-5 rounded border-gray-300 text-blue-600 shadow-sm 
                            focus:border-blue-500 focus:ring focus:ring-blue-500 
                            focus:ring-opacity-50
                       ">
                <span class="text-sm text-gray-700">Borrador</span>
            </label>
        </div>
    </div>

    <!-- Informaci√≥n de actualizaci√≥n -->
    <div class="p-6 bg-gray-50 border-t border-gray-200 text-sm text-gray-600">
        √öltima actualizaci√≥n: {{ recommendation.updated_at|date:"d/m/Y H:i" }}
        {% if recommendation.is_signed %}
            <span class="mx-2">‚Ä¢</span> 
            Firmado por {{ recommendation.signed_by }}
        {% endif %}
    </div>
</div>

{# Secci√≥n de Video #}
<div class="mt-8 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Video Informativo</h3>
    
    <div class="space-y-4">
        {% if video_url %}
            <div class="aspect-w-16 aspect-h-9">
                <video 
                    controls
                    class="w-full rounded-lg shadow-sm"
                    poster="{% static 'admin/img/video-poster.jpg' %}"
                >
                    <source src="{{ video_url }}" type="video/mp4">
                    Tu navegador no soporta el elemento video.
                </video>
            </div>
        {% endif %}

        {% if can_edit and not is_readonly %}
            <form method="POST" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                <div class="flex items-center justify-center w-full">
                    <label class="
                        flex flex-col items-center justify-center w-full h-32 
                        border-2 border-gray-300 border-dashed rounded-lg 
                        cursor-pointer bg-gray-50 hover:bg-gray-100
                    ">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="mb-2 text-sm text-gray-500">
                                <span class="font-semibold">Haz clic para subir</span> o arrastra y suelta
                            </p>
                            <p class="text-xs text-gray-500">MP4 (MAX. 100MB)</p>
                        </div>
                        <input type="file" name="video" accept="video/mp4" class="hidden" />
                    </label>
                </div>
                <button type="submit" class="
                    w-full px-4 py-2 text-sm font-medium text-white 
                    bg-blue-600 rounded-lg hover:bg-blue-700 
                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500
                ">
                    Subir Video
                </button>
            </form>
        {% endif %}
    </div>
    
    <div class="mt-4 text-sm text-gray-600">
        <p>Este video proporciona informaci√≥n importante sobre la evaluaci√≥n y recomendaciones.</p>
    </div>
</div>

<script src="{% static 'admin/js/admin/recommendation_editor.js' %}"></script> 