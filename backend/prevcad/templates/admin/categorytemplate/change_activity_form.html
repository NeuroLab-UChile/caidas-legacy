{% extends "admin/change_form.html" %}
{% load i18n static context json_tags %}

{% block extrahead %}
  {{ block.super }}
  <style>
    :root {
      --color-primary: #ffcc00;
      --color-secondary: #333333;
      --color-light: #ffffff;
      --color-dark: #222222;
      --color-danger: #e53e3e;
      --color-danger-hover: #c53030;
      --color-overlay: rgba(0, 0, 0, 0.5);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(6px);
      z-index: 1000;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }

    .modal-content {
      background-color: var(--color-light);
      border-radius: 1rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 600px;
      animation: slideUp 0.4s forwards;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .hidden {
      display: none;
    }

    .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-dark);
    }

    .btn-secondary {
      background-color: var(--color-secondary);
      color: var(--color-light);
    }

    .btn-danger {
      background-color: var(--color-danger);
      color: var(--color-light);
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
      transition: border-color 0.2s ease;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.1);
    }

    .node-card {
      background: white;
      border-radius: 0.75rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .node-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
{% endblock %}

{% block content %}
  {{ block.super }}

  <!-- Modal Unificado -->
  <div id="formModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 id="modalTitle" class="modal-title">Gestión de Formulario</h2>
      <div id="questionsList" class="overflow-y-auto max-h-[400px]">
        <!-- Dynamic content -->
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="addQuestionBtn" class="btn btn-primary" onclick="openAddQuestionModal()">
          Agregar
        </button>
        <button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Editar Pregunta -->
  <div id="questionModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="modal-title">Editar Pregunta</h2>
      <form id="questionForm">
        {% csrf_token %}
        <input type="hidden" id="nodeId">

        <div class="form-group">
          <label for="contentType">Tipo de Contenido</label>
          <select id="contentType" class="form-select" required onchange="toggleContentType()">
            <option value="">Seleccione el tipo</option>
            <option value="EVALUATION">Evaluación</option>
            <option value="TRAINING">Entrenamiento</option>
          </select>
        </div>

        <!-- Tipos para Evaluación -->
        <div id="evaluationTypes" class="form-group hidden">
          <label for="questionType">Tipo de Pregunta</label>
          <select id="questionType" class="form-select">
            <option value="MULTIPLE_CHOICE_QUESTION">Selección Múltiple</option>
            <option value="SINGLE_CHOICE_QUESTION">Selección Única</option>
            <option value="SCALE_QUESTION">Escala</option>
            <option value="TEXT_QUESTION">Texto</option>
            <option value="IMAGE_QUESTION">Imagen</option>
          </select>
        </div>

        <!-- Tipos para Entrenamiento -->
        <div id="trainingTypes" class="form-group hidden">
          <label for="trainingType">Tipo de Entrenamiento</label>
          <select id="trainingType" class="form-select">
            <option value="VIDEO">Video</option>
            <option value="TEXT">Texto</option>
            <option value="IMAGE">Imagen</option>
            <option value="DOCUMENT">Documento</option>
          </select>
        </div>

        <div class="form-group">
          <label for="questionText" id="contentLabel">Pregunta</label>
          <input type="text" id="questionText" class="form-input" required>
        </div>

        <div id="optionsContainer" class="hidden">
          <label>Opciones</label>
          <div class="flex gap-2 mb-2">
            <input type="text" id="newOption" class="form-input" placeholder="Nueva opción">
            <button type="button" id="addOptionBtn" class="btn btn-primary">+</button>
          </div>
          <ul id="optionsList" class="mt-2"></ul>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" class="btn btn-secondary" onclick="closeQuestionModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  {{ original.training_form|json_script:"training-form-data" }}
  {{ original.evaluation_form|json_script:"evaluation-form-data" }}

<script>
const trainingNodes = JSON.parse(document.getElementById('training-form-data').textContent || '{}').training_nodes || [];
const evaluationNodes = JSON.parse(document.getElementById('evaluation-form-data').textContent || '{}').question_nodes || [];
let options = [];

function closeModal() {
  document.querySelectorAll('.modal-overlay').forEach(modal => modal.classList.add('hidden'));
}

function toggleContentType() {
  const contentType = document.getElementById('contentType').value;
  const evaluationTypes = document.getElementById('evaluationTypes');
  const trainingTypes = document.getElementById('trainingTypes');
  const optionsContainer = document.getElementById('optionsContainer');
  const contentLabel = document.getElementById('contentLabel');
  
  evaluationTypes.classList.toggle('hidden', contentType !== 'EVALUATION');
  trainingTypes.classList.toggle('hidden', contentType !== 'TRAINING');
  optionsContainer.classList.add('hidden');
  
  contentLabel.textContent = contentType === 'TRAINING' ? 'Contenido' : 'Pregunta';
}

function openAddQuestionModal() {
  options = [];
  renderOptions();
  document.getElementById('questionModal').classList.remove('hidden');
}

function renderOptions() {
  const optionsList = document.getElementById('optionsList');
  optionsList.innerHTML = options.map((opt, index) => `
    <li>
      <input type="text" value="${opt}" onchange="updateOption(${index}, this.value)">
      <button onclick="removeOption(${index})">Eliminar</button>
    </li>
  `).join('');
}

function updateOption(index, value) {
  options[index] = value.trim();
}

function removeOption(index) {
  options.splice(index, 1);
  renderOptions();
}

function renderNodes(nodes, type) {
  console.log('Rendering nodes:', {type, nodes}); // Debug
  const questionsList = document.getElementById('questionsList');
  const typeLabels = {
    'MULTIPLE_CHOICE_QUESTION': 'Selección Múltiple',
    'SINGLE_CHOICE_QUESTION': 'Selección Única',
    'SCALE_QUESTION': 'Escala',
    'VIDEO_NODE': 'Video',
    'TEXT_NODE': 'Texto',
    'IMAGE_NODE': 'Imagen',
    'DOCUMENT_NODE': 'Documento',
    'TEXT_QUESTION': 'Texto',
    'IMAGE_QUESTION': 'Imagen',
    'TEXT_RECOMMENDATION': 'Texto',
    'IMAGE_RECOMMENDATION': 'Imagen',
    'TEXT_RECOMMENDATION_WITH_IMAGE': 'Texto con Imagen',
    'IMAGE_RECOMMENDATION_WITH_TEXT': 'Imagen con Texto'
  };

  questionsList.innerHTML = nodes.map((node, index) => `
    <div class="node-card">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <span class="font-semibold">#${index + 1}</span>
          <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
            ${typeLabels[node.type] || node.type}
          </span>
        </div>
        <div class="flex gap-2">
          <button 
            onclick='editNode(${JSON.stringify(node).replace(/'/g, "&#39;")}, "${type}")'
            class="btn btn-primary"
          >
            Editar
          </button>
          <button 
            onclick='deleteNode(${node.id}, "${type}")'
            class="btn btn-danger"
          >
            Eliminar
          </button>
        </div>
      </div>
      <p class="text-lg">${type === 'TRAINING' ? node.content : node.question}</p>
      ${node.options ? `
        <div class="mt-3">
          <p class="font-medium mb-2">Opciones:</p>
          <ul class="space-y-1">
            ${node.options.map(opt => `
              <li class="flex items-center gap-2">
                <span>•</span>
                <span>${opt}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      ` : ''}
    </div>
  `).join('');
}

function openFormModal(type) {
  const modal = document.getElementById('formModal');
  const modalTitle = document.getElementById('modalTitle');
  const nodes = type === 'TRAINING' ? trainingNodes : evaluationNodes;

  // Cambiar el título del modal según el tipo
  modalTitle.textContent = type === 'TRAINING' ? 
    'Gestión de Contenido de Entrenamiento' : 
    'Gestión de Preguntas de Evaluación';

  // Renderizar los nodos correspondientes en el modal
  renderNodes(nodes, type);

  // Mostrar el modal
  modal.classList.remove('hidden');
}

function saveQuestion(event) {
    event.preventDefault(); // Prevenir el envío por defecto del formulario
    
    const contentType = document.getElementById('contentType').value;
    const nodeId = document.getElementById('nodeId').value;
    const questionText = document.getElementById('questionText').value;

    if (!contentType || !questionText) {
        alert('Por favor complete todos los campos requeridos');
        return;
    }

    const nodeData = {
        id: nodeId ? parseInt(nodeId) : Date.now(),
        content: questionText,
        type: contentType === 'TRAINING' ? 
            document.getElementById('trainingType').value + '_NODE' :
            document.getElementById('questionType').value
    };

    if (contentType === 'EVALUATION') {
        nodeData.question = questionText;
        delete nodeData.content;
        
        if (['MULTIPLE_CHOICE_QUESTION', 'SINGLE_CHOICE_QUESTION'].includes(nodeData.type)) {
            if (options.length < 2) {
                alert('Se requieren al menos 2 opciones para preguntas de selección');
                return;
            }
            nodeData.options = options;
        }
    }

    // Obtener los nodos actuales
    const currentNodes = contentType === 'TRAINING' ? 
        trainingNodes : evaluationNodes;

    // Actualizar o agregar el nodo
    let updatedNodes;
    if (nodeId) {
        updatedNodes = currentNodes.map(node => 
            node.id === parseInt(nodeId) ? nodeData : node
        );
    } else {
        updatedNodes = [...currentNodes, nodeData];
    }

    // Preparar formData
    const formData = new FormData();
    if (contentType === 'TRAINING') {
        formData.append('training_form', JSON.stringify({
            training_nodes: updatedNodes
        }));
    } else {
        formData.append('evaluation_form', JSON.stringify({
            question_nodes: updatedNodes
        }));
    }

    // Enviar al servidor
    const endpoint = contentType === 'TRAINING' ?
        "{% url 'update_training_form' original.id %}" :
        "{% url 'update_evaluation_form' original.id %}";

    fetch(endpoint, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            alert('Guardado correctamente');
            location.reload();
        } else {
            throw new Error(data.message || 'Error al guardar');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
    });
}

function deleteNode(nodeId, type) {
  if (!confirm(`¿Está seguro de eliminar este ${type === 'TRAINING' ? 'contenido' : 'pregunta'}?`)) {
    return;
  }

  // Obtener los nodos actuales según el tipo
  let currentNodes;
  if (type === 'TRAINING') {
    currentNodes = {{ original.training_form.training_nodes|safe }};
  } else {
    currentNodes = {{ original.evaluation_form.question_nodes|safe }};
  }

  console.log('Current nodes before deletion:', currentNodes); // Debug

  // Filtrar el nodo a eliminar
  const updatedNodes = currentNodes.filter(node => node.id !== nodeId);
  
  console.log('Updated nodes after deletion:', updatedNodes); // Debug

  // Preparar el formData
  const formData = new FormData();
  
  if (type === 'TRAINING') {
    formData.append('training_form', JSON.stringify({
      training_nodes: updatedNodes
    }));
    console.log('Training form data:', formData.get('training_form')); // Debug
  } else {
    formData.append('evaluation_form', JSON.stringify({
      question_nodes: updatedNodes
    }));
  }

  // Obtener el endpoint correcto y asegurarse de que original.id está disponible
  const endpoint = type === 'TRAINING' ?
    "{% url 'update_training_form' original.id %}" :
    "{% url 'update_evaluation_form' original.id %}";

  console.log('Sending request to:', endpoint); // Debug

  // Realizar la petición
  fetch(endpoint, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => {
        console.error('Server response:', text);
        throw new Error(`HTTP error! status: ${response.status}`);
      });
    }
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data); // Debug
    if (data.status === 'success') {
      alert(type === 'TRAINING' ? 
        'Contenido eliminado correctamente' : 
        'Pregunta eliminada correctamente'
      );
      location.reload();
    } else {
      throw new Error(data.message || 'Error al eliminar');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert(`Error al eliminar: ${error.message}`);
  });
}

function closeQuestionModal() {
    document.getElementById('questionModal').classList.add('hidden');
    document.getElementById('questionForm').reset();
    options = [];
    renderOptions();
}

function editNode(node, type) {
    // Resetear el formulario
    document.getElementById('questionForm').reset();
    options = [];
    
    // Establecer valores
    document.getElementById('nodeId').value = node.id;
    document.getElementById('contentType').value = type;
    document.getElementById('questionText').value = type === 'TRAINING' ? node.content : node.question;
    
    // Mostrar campos según el tipo
    toggleContentType();
    
    if (type === 'TRAINING') {
        document.getElementById('trainingType').value = node.type.replace('_NODE', '');
        document.getElementById('contentLabel').textContent = 'Contenido';
    } else {
        document.getElementById('questionType').value = node.type;
        document.getElementById('contentLabel').textContent = 'Pregunta';
        
        if (node.options) {
            options = [...node.options];
            renderOptions();
            document.getElementById('optionsContainer').classList.remove('hidden');
        }
    }
    
    // Mostrar modal
    document.getElementById('questionModal').classList.remove('hidden');
}

renderNodes(trainingNodes, 'TRAINING');
renderNodes(evaluationNodes, 'EVALUATION');

document.addEventListener('DOMContentLoaded', function() {
    // Form submit handler
    document.getElementById('questionForm').addEventListener('submit', saveQuestion);

    // Add option button handler
    document.getElementById('addOptionBtn').addEventListener('click', function() {
        const newOption = document.getElementById('newOption');
        if (newOption.value.trim()) {
            options.push(newOption.value.trim());
            newOption.value = '';
            renderOptions();
        }
    });

    // Question type change handler
    document.getElementById('questionType').addEventListener('change', function() {
        const isChoiceQuestion = ['MULTIPLE_CHOICE_QUESTION', 'SINGLE_CHOICE_QUESTION'].includes(this.value);
        document.getElementById('optionsContainer').classList.toggle('hidden', !isChoiceQuestion);
    });
});
</script>
{% endblock %}
