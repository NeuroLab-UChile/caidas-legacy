{% extends "admin/change_form.html" %}
{% load i18n static context json_tags %}

{% block extrahead %}
  {{ block.super }}
  <style>
    :root {
      --color-primary: #ffcc00;
      --color-secondary: #333333;
      --color-light: #ffffff;
      --color-dark: #222222;
      --color-danger: #e53e3e;
      --color-danger-hover: #c53030;
      --color-overlay: rgba(0, 0, 0, 0.5);
      --color-text-dark: #1a202c;
      --color-border: #e2e8f0;
      --color-success: #38a169;
      --color-info: #3182ce;
      --color-warning: #d69e2e;
    }

    /* Estilos para notificaciones */
    #notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .notification {
      background-color: var(--color-light);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideIn 0.3s ease-out;
      border-left: 4px solid var(--color-info);
    }

    .notification-success {
      border-left-color: var(--color-success);
    }

    .notification-error {
      border-left-color: var(--color-danger);
    }

    .notification-warning {
      border-left-color: var(--color-warning);
    }

    .notification-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification-icon {
      font-size: 18px;
      font-weight: bold;
    }

    .notification-success .notification-icon {
      color: var(--color-success);
    }

    .notification-error .notification-icon {
      color: var(--color-danger);
    }

    .notification-warning .notification-icon {
      color: var(--color-warning);
    }

    .notification-message {
      font-size: 14px;
      color: var(--color-text-dark);
    }

    .notification-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #718096;
      padding: 0;
      margin-left: 10px;
    }

    .notification-close:hover {
      color: var(--color-text-dark);
    }

    .fade-out {
      animation: fadeOut 0.3s ease-in forwards;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Estilos para el spinner de carga */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mejoras en los botones */
    .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      font-weight: 600;
      letter-spacing: 0.025em;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-dark);
    }

    .btn-secondary {
      background-color: var(--color-secondary);
      color: var(--color-light);
    }

    .btn-danger {
      background-color: var(--color-danger);
      color: var(--color-light);
    }

    /* Mejoras en los inputs */
    .form-input,
    .form-select {
      width: 100%;
      padding: 0.625rem;
      border: 2px solid var(--color-border);
      border-radius: 0.375rem;
      margin-bottom: 0.5rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      color: var(--color-text-dark);
      font-weight: 500;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(255, 204, 0, 0.1);
    }

    .form-input:invalid,
    .form-select:invalid {
      border-color: var(--color-danger);
    }

    /* Mejoras en las tarjetas de nodos */
    .node-card {
      background: var(--color-light);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
    }

    .node-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    /* Resto de estilos existentes */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(6px);
      z-index: 1000;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }

    .modal-content {
      background-color: var(--color-light);
      border-radius: 1rem;
      padding: 2rem;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.4s forwards;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .hidden {
      display: none;
    }

    .media-thumbnail {
        max-width: 200px;
        max-height: 150px;
        object-fit: cover;
        border-radius: 0.5rem;
        margin-top: 0.5rem;
    }

    .video-thumbnail {
        width: 200px;
        height: 150px;
        background: #f1f1f1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        position: relative;
    }

    .video-thumbnail::after {
        content: "▶";
        font-size: 2rem;
        color: #666;
    }

    .media-container {
        max-height: 200px;
        overflow-y: auto;
        padding: 1.25rem;
        border: 2px solid var(--color-border);
        border-radius: 0.75rem;
        margin-top: 1rem;
    }

    .current-media-preview {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid var(--color-border);
    }

    .current-media-label {
        font-size: 0.875rem;
        color: #4a5568;
        margin-bottom: 0.5rem;
    }

    .media-thumbnail {
        max-width: 200px;
        max-height: 150px;
        object-fit: cover;
        border-radius: 0.5rem;
    }

    .video-thumbnail {
        width: 200px;
        height: 150px;
        background: #f1f1f1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        position: relative;
    }

    .video-thumbnail::after {
        content: "▶";
        font-size: 2rem;
        color: #666;
    }

    .media-name {
        font-size: 0.875rem;
        color: #4a5568;
        margin-top: 0.5rem;
        word-break: break-all;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--color-text-dark);
      margin-bottom: 1.5rem;
    }

    #optionsList li {
      background-color: #f8fafc;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid var(--color-border);
    }

    #optionsList input {
      border: 2px solid var(--color-border);
      padding: 0.5rem;
      border-radius: 0.375rem;
    }

    .media-preview {
        max-width: 320px;
        max-height: 240px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        object-fit: contain;
    }

    .media-name {
        margin-top: 8px;
        font-size: 0.9em;
        color: #666;
    }

    .node-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }
  </style>
{% endblock %}

{% block content %}
  {{ block.super }}

  <!-- Modal para gestión de formulario -->
  <div id="formModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 id="modalTitle" class="modal-title">Gestión de Formulario</h2>
      <div id="questionsList" class="overflow-y-auto max-h-[400px]">
        <!-- Contenido dinámico -->
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
        <button id="addQuestionBtn" class="btn btn-primary" onclick="openAddQuestionModal()">
            Agregar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Editar Pregunta -->
  <div id="questionModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="modal-title">Editar Pregunta</h2>
      <form id="questionForm">
        {% csrf_token %}
        <input type="hidden" id="nodeId">

        <div class="form-group">
          <label for="contentType">Tipo de Contenido</label>
          <select id="contentType" class="form-select" required onchange="toggleContentType()">
            <option value="">Seleccione el tipo</option>
            <option value="EVALUATION">Evaluación</option>
            <option value="TRAINING">Entrenamiento</option>
          </select>
        </div>

        <!-- Tipos para Entrenamiento -->
        <div id="trainingTypes" class="form-group hidden">
          <label for="trainingType">Tipo de Entrenamiento</label>
          <select id="trainingType" class="form-select" onchange="toggleMediaType()">
            <option value="VIDEO">Video</option>
            <option value="IMAGE">Imagen</option>
            <option value="TEXT">Texto</option>
            <option value="DESCRIPTION">Descripción</option>
            <option value="WEEKLY_RECIPE">Plan Semanal</option>
          </select>
        </div>

        <!-- Tipos para Evaluación -->
        <div id="evaluationTypes" class="form-group hidden">
            <label for="questionType">Tipo de Pregunta</label>
            <select id="questionType" class="form-select" onchange="handleQuestionTypeChange()">
                <option value="SINGLE_CHOICE_QUESTION">Opción única</option>
                <option value="MULTIPLE_CHOICE_QUESTION">Opción múltiple</option>
                <option value="TEXT_QUESTION">Pregunta de texto</option>
                <option value="IMAGE_QUESTION">Pregunta con imagen</option>
                <option value="SCALE_QUESTION">Pregunta de escala</option>
            </select>
        </div>

        <div class="form-group">
          <label for="questionText" id="contentLabel">Pregunta</label>
          <input type="text" id="questionText" class="form-input" required>
        </div>

        <div id="optionsContainer" class="hidden">
          <label>Opciones</label>
          <div class="flex gap-2 mb-2">
            <input type="text" id="newOption" class="form-input" placeholder="Nueva opción">
            <button type="button" id="addOptionBtn" class="btn btn-primary">+</button>
          </div>
          <ul id="optionsList" class="mt-2"></ul>
        </div>

        <div id="mediaContainer" class="form-group hidden">
            <!-- Container para Video -->
            <div id="videoInputContainer" class="hidden">
                <label for="video">Video</label>
                <input type="file" 
                       id="video" 
                       name="video" 
                       class="form-input" 
                       accept="video/*"
                       onchange="handleFilePreview(event, 'video')">
            </div>

            <!-- Container para Imagen -->
            <div id="imageInputContainer" class="hidden">
                <label for="image">Imagen</label>
                <input type="file" 
                       id="image" 
                       name="image" 
                       class="form-input" 
                       accept="image/*"
                       onchange="handleFilePreview(event, 'image')">
            </div>

            <!-- Vista previa del contenido multimedia -->
            <div id="mediaPreview" class="mt-4">
                <div id="currentMedia" class="mb-4">
                    <!-- Aquí se mostrará el contenido actual -->
                </div>
                <div id="newMediaPreview" class="hidden">
                    <!-- Aquí se mostrará la vista previa del nuevo contenido -->
                </div>
            </div>
        </div>

        <div id="weeklyRecipeContainer" class="form-group">
            <label class="block mb-2 font-semibold">Plan Semanal de Comidas</label>
            <textarea 
                id="weeklyPlanTextarea" 
                rows="10" 
                class="form-input w-full font-mono"
                placeholder='Estructura sugerida:
{
    "Lunes": {
        "Desayuno": "Descripción del desayuno",
        "Almuerzo": "Descripción del almuerzo",
        "Cena": "Descripción de la cena"
    },
    "Martes": { ... }
}

Puedes modificar esta estructura o escribir texto libre.'
            ></textarea>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" class="btn btn-secondary" onclick="closeQuestionModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  {{ original.training_form|json_script:"training-form-data" }}
  {{ original.evaluation_form|json_script:"evaluation-form-data" }}

  <script>
    // Estado global
    const state = {
        trainingNodes: [],
        evaluationNodes: [],
        options: [],
        currentType: null,
        mediaPreview: null,
        evaluationType: '{{ original.evaluation_type }}'
    };

    // Constantes
    const MAX_FILE_SIZE = 500 * 1024 * 1024; // 500MB
    const NODE_TYPES = {
        TRAINING: {
            VIDEO: 'VIDEO_NODE',
            IMAGE: 'IMAGE_NODE',
            TEXT: 'TEXT_NODE',
            DESCRIPTION: 'DESCRIPTION_NODE',
            WEEKLY_RECIPE: 'WEEKLY_RECIPE_NODE'
        },
        EVALUATION: {
            SINGLE_CHOICE: 'SINGLE_CHOICE_QUESTION',
            MULTIPLE_CHOICE: 'MULTIPLE_CHOICE_QUESTION',
            TEXT: 'TEXT_QUESTION',
            IMAGE: 'IMAGE_QUESTION',
            SCALE: 'SCALE_QUESTION'
        }
    };

    // Utilidades
    const utils = {
        getNodeTypeName(type) {
            const typeMap = {
                [NODE_TYPES.TRAINING.VIDEO]: 'Video',
                [NODE_TYPES.TRAINING.IMAGE]: 'Imagen',
                [NODE_TYPES.TRAINING.TEXT]: 'Texto',
                [NODE_TYPES.TRAINING.DESCRIPTION]: 'Descripción',
                [NODE_TYPES.TRAINING.WEEKLY_RECIPE]: 'Plan Semanal',
                [NODE_TYPES.EVALUATION.SINGLE_CHOICE]: 'Opción única',
                [NODE_TYPES.EVALUATION.MULTIPLE_CHOICE]: 'Opción múltiple',
                [NODE_TYPES.EVALUATION.TEXT]: 'Pregunta de texto',
                [NODE_TYPES.EVALUATION.IMAGE]: 'Pregunta con imagen',
                [NODE_TYPES.EVALUATION.SCALE]: 'Pregunta de escala'
            };
            return typeMap[type] || 'Otro tipo';
        },

        validateFile(file) {
            if (!file) return { valid: true };
            if (file.size > MAX_FILE_SIZE) {
                return { 
                    valid: false, 
                    error: `El archivo es demasiado grande. Tamaño máximo: ${MAX_FILE_SIZE / (1024 * 1024)}MB` 
                };
            }
            return { valid: true };
        },

        getMediaUrl(url) {
            return url?.startsWith('/') ? url : `/media/${url}`;
        }
    };

    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const trainingData = JSON.parse(document.getElementById('training-form-data')?.textContent || '{}');
        const evaluationData = JSON.parse(document.getElementById('evaluation-form-data')?.textContent || '{}');

        state.trainingNodes = (trainingData?.training_nodes || []).map(node => ({
            ...node,
            id: node.id?.toString() || crypto.randomUUID()
        }));
        
        state.evaluationNodes = (evaluationData?.question_nodes || []).map(node => ({
            ...node,
            id: node.id?.toString() || crypto.randomUUID()
        }));

        initializeEventListeners();
        renderNodes(state.trainingNodes, 'TRAINING');
      } catch (error) {
        console.error('Error al inicializar datos:', error);
        showNotification('Error al cargar los datos iniciales', 'error');
      }
    });

    // Event Listeners
    function initializeEventListeners() {
        const questionForm = document.getElementById('questionForm');
        if (questionForm) {
            questionForm.addEventListener('submit', saveQuestion);
        }

        const addOptionBtn = document.getElementById('addOptionBtn');
        const newOption = document.getElementById('newOption');
        if (addOptionBtn && newOption) {
            addOptionBtn.addEventListener('click', () => {
                if (newOption.value.trim()) {
                    state.options.push(newOption.value.trim());
                    newOption.value = '';
                    renderOptions();
                }
            });
        }

        const questionType = document.getElementById('questionType');
        if (questionType) {
            questionType.addEventListener('change', handleQuestionTypeChange);
        }

        const trainingType = document.getElementById('trainingType');
        if (trainingType) {
            trainingType.addEventListener('change', toggleMediaType);
        }

        const contentType = document.getElementById('contentType');
        if (contentType) {
            contentType.addEventListener('change', () => {
                toggleContentType();
            });
        }
    }

    // Funciones principales
    function editNode(nodeId, type) {
      if (!nodeId || nodeId === 'null') {
            showNotification('ID de nodo inválido', 'error');
        return;
      }

        const nodes = type === 'TRAINING' ? state.trainingNodes : state.evaluationNodes;
        const targetIdStr = String(nodeId);
        const node = nodes.find(n => String(n.id) === targetIdStr);

      if (!node) {
            showNotification('Nodo no encontrado', 'error');
        return;
      }

      try {
        const questionModal = document.getElementById('questionModal');
        questionModal?.classList.remove('hidden');

            document.getElementById('nodeId').value = nodeId;

        const contentTypeSelect = document.getElementById('contentType');
        if (contentTypeSelect) {
          contentTypeSelect.value = type;
          contentTypeSelect.disabled = true;
        }

        const questionText = document.getElementById('questionText');
        if (questionText) {
          questionText.value = type === 'TRAINING' ? (node.content || '') : (node.question || '');
        }

        if (type === 'TRAINING') {
                setupTrainingNode(node);
            } else {
                setupEvaluationNode(node);
            }

            toggleContentType();
        } catch (error) {
            console.error('Error al editar nodo:', error);
            showNotification('Error al editar el nodo', 'error');
        }
    }

    function setupTrainingNode(node) {
        const trainingType = node.type?.replace('_NODE', '') || 'VIDEO';
        const trainingTypeSelect = document.getElementById('trainingType');
        if (trainingTypeSelect) {
            trainingTypeSelect.value = trainingType;
            toggleMediaType();
        }

        // Special handling for Weekly Recipe
        if (trainingType === 'WEEKLY_RECIPE') {
            setupWeeklyRecipeNode(node);
        } else if (node.media_url) {
            const mediaContainer = document.getElementById('mediaContainer');
            mediaContainer?.classList.remove('hidden');
            showCurrentMedia(node.media_url, trainingType);
        }
    }

    function setupEvaluationNode(node) {
          const questionTypeSelect = document.getElementById('questionType');
          if (questionTypeSelect) {
            questionTypeSelect.value = node.type || NODE_TYPES.EVALUATION.SINGLE_CHOICE;
          }

          if (node.options?.length) {
            state.options = [...node.options];
            renderOptions();
            const optionsContainer = document.getElementById('optionsContainer');
            if (optionsContainer) {
                optionsContainer.classList.remove('hidden');
            }
        }
    }

    function saveQuestion(event) {
        event.preventDefault();
        
        try {
            const formData = prepareFormData();
            if (!formData) return;

            const saveButton = document.querySelector('#questionForm button[type="submit"]');
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<span class="loading-spinner"></span> Guardando...';
            }

            submitFormData(formData)
                .then(handleSaveSuccess)
                .catch(handleSaveError)
                .finally(() => {
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = 'Guardar';
                    }
                });
        } catch (error) {
            console.error('Error al guardar:', error);
            showNotification(`Error inesperado: ${error.message}`, 'error');
        }
    }

    function prepareFormData() {
        const contentType = document.getElementById('contentType')?.value;
        const nodeId = document.getElementById('nodeId')?.value;
        const questionText = document.getElementById('questionText')?.value;
        const videoFile = document.getElementById('video')?.files?.[0];
        const imageFile = document.getElementById('image')?.files?.[0];

        if (!contentType || !questionText) {
            showNotification('Por favor complete los campos requeridos', 'error');
            return null;
        }

        const nodeData = createNodeData(contentType, nodeId, questionText, videoFile, imageFile);
        if (!nodeData) return null;

        const formData = new FormData();
        if (videoFile) formData.append('video', videoFile);
        if (imageFile) formData.append('image', imageFile);
        
        const formKey = contentType === 'TRAINING' ? 'training_form' : 'evaluation_form';
        const nodesKey = contentType === 'TRAINING' ? 'training_nodes' : 'question_nodes';
        
        formData.append(formKey, JSON.stringify({
            [nodesKey]: updateNodesList(nodeData, contentType)
        }));

        return formData;
    }

    function createNodeData(contentType, nodeId, questionText, videoFile, imageFile) {
        const nodeData = {
            id: nodeId ? String(nodeId) : String(Date.now()),
            type: contentType === 'TRAINING' ? 
                (document.getElementById('trainingType')?.value + '_NODE') :
                document.getElementById('questionType')?.value
        };
        
        if (contentType === 'TRAINING') {
            nodeData.title = document.getElementById('questionText')?.value || 'Plan Semanal';
            nodeData.description = 'Plan de alimentación personalizado';

            if (nodeData.type === NODE_TYPES.TRAINING.WEEKLY_RECIPE) {
                const textarea = document.getElementById('weeklyPlanTextarea');
                
                if (!textarea) {
                    showNotification('No se encontró el área de texto para el plan semanal', 'error');
                    return null;
                }

                try {
                    const weeklyPlan = JSON.parse(textarea.value);
                    
                    if (!validateWeeklyPlan()) {
                        showNotification('El plan semanal no es válido', 'error');
                        return null;
                    }

                    nodeData.weekly_plan = weeklyPlan;
                } catch (error) {
                    showNotification(`Error al procesar el plan: ${error.message}`, 'error');
                    return null;
                }
            }

            // Manejo de archivos multimedia existente
            if (videoFile || imageFile) {
                const file = videoFile || imageFile;
                const validation = utils.validateFile(file);
                if (!validation.valid) {
                    showNotification(validation.error, 'error');
                    return null;
                }
                nodeData.media_pending = true;
                nodeData.media_url = file.name;
            }
        } else {
            // Lógica existente para otros tipos de nodos
            nodeData.question = questionText;
            if (['MULTIPLE_CHOICE_QUESTION', 'SINGLE_CHOICE_QUESTION'].includes(nodeData.type)) {
                if (!state.options.length) {
                    showNotification('Por favor agregue al menos una opción', 'error');
                    return null;
                }
                nodeData.options = state.options;
            }
        }

        return nodeData;
    }

    function updateNodesList(newNode, type) {
        const currentNodes = type === 'TRAINING' ? state.trainingNodes : state.evaluationNodes;
        const updatedNodes = currentNodes.map(node => 
            String(node.id) === String(newNode.id) ? {...node, ...newNode} : node
        );

        if (!currentNodes.some(node => String(node.id) === String(newNode.id))) {
            updatedNodes.push(newNode);
        }

        if (type === 'TRAINING') {
            state.trainingNodes = updatedNodes;
            } else {
            state.evaluationNodes = updatedNodes;
        }

        return updatedNodes;
    }

    async function submitFormData(formData) {
        const contentType = document.getElementById('contentType')?.value;
        const url = contentType === 'TRAINING' ?
            "{% url 'update_training_form' original.id %}" :
            "{% url 'update_evaluation_form' original.id %}";

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        });

        if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            throw new Error(data.message || `Error del servidor: ${response.status}`);
        }

        return response.json();
    }

    function handleSaveSuccess(data) {
            if (data.status === 'success') {
            showNotification('Guardado correctamente', 'success');
            closeQuestionModal();
            const contentType = document.getElementById('contentType')?.value;
            const nodes = contentType === 'TRAINING' ? state.trainingNodes : state.evaluationNodes;
            renderNodes(nodes, contentType);
            } else {
                throw new Error(data.message || 'Error al guardar');
            }
    }

    function handleSaveError(error) {
            console.error('Error:', error);
        showNotification(`Error: ${error.message}`, 'error');
    }

    function deleteNode(nodeId, type) {
      if (!confirm(`¿Está seguro de eliminar este ${type === 'TRAINING' ? 'contenido' : 'pregunta'}?`)) {
        return;
      }

        try {
            // Obtener los nodos actuales
            const currentNodes = type === 'TRAINING' ? state.trainingNodes : state.evaluationNodes;

      // Filtrar el nodo a eliminar
            const updatedNodes = currentNodes.filter(node => String(node.id) !== String(nodeId));
            
            // Verificar que realmente se eliminó un nodo
            if (updatedNodes.length === currentNodes.length) {
                showNotification('No se encontró el nodo a eliminar', 'warning');
                return;
            }
      
      // Preparar el formData
      const formData = new FormData();
            const formKey = type === 'TRAINING' ? 'training_form' : 'evaluation_form';
            const nodesKey = type === 'TRAINING' ? 'training_nodes' : 'question_nodes';
            
            // Asegurarse de que el formData tenga el formato correcto
            const formDataObject = {
                [nodesKey]: updatedNodes
            };
            
            // Agregar el token CSRF
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken);
            }
            
            // Agregar los datos del formulario
            formData.append(formKey, JSON.stringify(formDataObject));
            
            // Mostrar indicador de carga
            const deleteButton = document.querySelector(`button[onclick="deleteNode('${nodeId}', '${type}')"]`);
            if (deleteButton) {
                deleteButton.disabled = true;
                deleteButton.innerHTML = '<span class="loading-spinner"></span> Eliminando...';
            }

            // Realizar la petición al servidor
            const url = type === 'TRAINING' ?
        "{% url 'update_training_form' original.id %}" :
        "{% url 'update_evaluation_form' original.id %}";

            fetch(url, {
        method: 'POST',
        headers: {
                    'X-CSRFToken': csrfToken
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || `Error del servidor: ${response.status}`);
                    }).catch(() => {
                        throw new Error(`Error del servidor: ${response.status}`);
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
                    // Actualizar el estado local
                    if (type === 'TRAINING') {
                        state.trainingNodes = updatedNodes;
                    } else {
                        state.evaluationNodes = updatedNodes;
                    }
                    
                    // Actualizar la vista
                    renderNodes(updatedNodes, type);
                    
                    // Mostrar notificación de éxito
                    showNotification(
                        type === 'TRAINING' ? 
            'Contenido eliminado correctamente' : 
                        'Pregunta eliminada correctamente',
                        'success'
          );
        } else {
          throw new Error(data.message || 'Error al eliminar');
        }
      })
      .catch(error => {
                console.error('Error al eliminar:', error);
                showNotification('Error al eliminar: ' + error.message, 'error');
                
                // En caso de error, intentar actualizar la vista de todas formas
                if (type === 'TRAINING') {
                    state.trainingNodes = updatedNodes;
                } else {
                    state.evaluationNodes = updatedNodes;
                }
                renderNodes(updatedNodes, type);
            })
            .finally(() => {
                // Restaurar el botón
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = 'Eliminar';
                }
            });
        } catch (error) {
            console.error('Error al eliminar:', error);
            showNotification('Error al eliminar: ' + error.message, 'error');
        }
    }

    // UI Helpers
    function renderNodes(nodes, type) {
        const container = document.getElementById('questionsList');
        if (!container) return;
        
        container.innerHTML = nodes.map((node, index) => {
            const mediaHtml = createMediaHtml(node);
            
            return `
                <div class="node-card p-4 mb-4 border rounded shadow-sm">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold">#${index + 1}</span>
                            <span class="ml-2">${utils.getNodeTypeName(node.type)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editNode('${node.id}', '${type}')" 
                                    class="btn btn-primary">
                                Editar
                            </button>
                            <button onclick="deleteNode('${node.id}', '${type}')" 
                                    class="btn btn-danger">
                                Eliminar
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <h3 class="font-semibold text-lg">${node.title || node.content || 'Sin título'}</h3>
                        <p class="text-gray-600">${getNodeSummary(node)}</p>
                    </div>
                    
                    ${mediaHtml}
                </div>
            `;
        }).join('');
    }

    function getNodeSummary(node) {
        switch(node.type) {
            case 'WEEKLY_RECIPE_NODE':
                return 'Plan nutricional semanal';
            case 'DESCRIPTION_NODE':
                return node.description ? node.description.substring(0, 100) + '...' : 'Descripción';
            case 'VIDEO_NODE':
                return 'Video de entrenamiento';
            case 'IMAGE_NODE':
                return 'Imagen de entrenamiento';
            default:
                return node.content || node.question || 'Sin descripción';
        }
    }

    function createMediaHtml(node) {
        if (!node.media_url) return '';
        
        const mediaUrl = utils.getMediaUrl(node.media_url);
        
        if (node.type === NODE_TYPES.TRAINING.VIDEO) {
            return `
                <div class="mt-3">
                    <video controls class="max-w-full h-auto rounded">
                        <source src="${mediaUrl}" type="video/mp4">
                        <source src="${mediaUrl}" type="video/quicktime">
                        <source src="${mediaUrl}" type="video/mov">
                        Tu navegador no soporta el elemento de video.
                    </video>
                </div>`;
        } else if ([NODE_TYPES.TRAINING.IMAGE, NODE_TYPES.EVALUATION.IMAGE].includes(node.type)) {
            return `
                <div class="mt-3">
                    <img src="${mediaUrl}" alt="Imagen" class="max-w-full h-auto rounded">
                </div>`;
        }
        return '';
    }

    function renderOptions() {
        const optionsList = document.getElementById('optionsList');
        if (!optionsList) return;

        optionsList.innerHTML = state.options.map((option, index) => `
            <li class="flex justify-between items-center p-2 bg-gray-50 rounded mb-2">
                <span>${option}</span>
                <button type="button" 
                        onclick="removeOption(${index})" 
                        class="text-red-500 hover:text-red-700">
                    ×
                </button>
            </li>
        `).join('');
    }

    function removeOption(index) {
        state.options.splice(index, 1);
        renderOptions();
    }

    function handleQuestionTypeChange() {
        const questionType = document.getElementById('questionType')?.value;
        const optionsContainer = document.getElementById('optionsContainer');
        
        if (optionsContainer) {
            const isChoiceQuestion = [
                NODE_TYPES.EVALUATION.MULTIPLE_CHOICE,
                NODE_TYPES.EVALUATION.SINGLE_CHOICE
            ].includes(questionType);
            
            optionsContainer.classList.toggle('hidden', !isChoiceQuestion);
            
            if (questionType === NODE_TYPES.EVALUATION.SINGLE_CHOICE) {
                state.options = ['Sí', 'No'];
            renderOptions();
            }
        }
    }

    function toggleContentType() {
        const contentType = document.getElementById('contentType')?.value;
        const trainingTypes = document.getElementById('trainingTypes');
        const evaluationTypes = document.getElementById('evaluationTypes');
        const mediaContainer = document.getElementById('mediaContainer');
        const weeklyRecipeContainer = document.getElementById('weeklyRecipeContainer');
        
        if (!contentType) return;

        trainingTypes?.classList.toggle('hidden', contentType !== 'TRAINING');
        evaluationTypes?.classList.toggle('hidden', contentType !== 'EVALUATION');
        mediaContainer?.classList.toggle('hidden', contentType !== 'TRAINING');
        weeklyRecipeContainer?.classList.toggle('hidden', 
            contentType !== 'TRAINING' || 
            document.getElementById('trainingType')?.value !== 'WEEKLY_RECIPE'
        );
        
        if (contentType === 'TRAINING') {
            toggleMediaType();
        }
    }

    function toggleMediaType() {
        const trainingType = document.getElementById('trainingType')?.value;
        const videoContainer = document.getElementById('videoInputContainer');
        const imageContainer = document.getElementById('imageInputContainer');
        const weeklyRecipeContainer = document.getElementById('weeklyRecipeContainer');
        
        if (!trainingType) return;

        videoContainer?.classList.toggle('hidden', trainingType !== 'VIDEO');
        imageContainer?.classList.toggle('hidden', trainingType !== 'IMAGE');
        weeklyRecipeContainer?.classList.toggle('hidden', trainingType !== 'WEEKLY_RECIPE');
    }

    function handleFilePreview(event, type) {
        const file = event.target.files[0];
        if (!file) return;

        const validation = utils.validateFile(file);
        if (!validation.valid) {
            showNotification(validation.error, 'error');
            event.target.value = '';
            return;
        }

        const newMediaPreview = document.getElementById('newMediaPreview');
        newMediaPreview.classList.remove('hidden');

        if (type === 'video') {
            const videoUrl = URL.createObjectURL(file);
            newMediaPreview.innerHTML = `
                <h4>Vista previa del nuevo video:</h4>
                <video controls width="320" class="media-preview">
                    <source src="${videoUrl}" type="${file.type}">
                    Tu navegador no soporta la reproducción de video.
                </video>
                <div class="media-name">${file.name}</div>
            `;
        } else if (type === 'image') {
            const reader = new FileReader();
            reader.onload = function(e) {
                newMediaPreview.innerHTML = `
                    <h4>Vista previa de la nueva imagen:</h4>
                    <img src="${e.target.result}" class="media-preview" alt="Vista previa">
                    <div class="media-name">${file.name}</div>
                `;
            };
            reader.readAsDataURL(file);
        }
    }

    function showCurrentMedia(mediaUrl, type) {
  const currentMedia = document.getElementById('currentMedia');
        if (!currentMedia || !mediaUrl) return;

  const mediaContainer = document.getElementById('mediaContainer');
  const mediaPreview = document.getElementById('mediaPreview');
  
  if (mediaContainer) mediaContainer.classList.remove('hidden');
  if (mediaPreview) mediaPreview.classList.remove('hidden');
  
  const mediaName = mediaUrl.split('/').pop();
        const isVideo = type === 'VIDEO' || type === NODE_TYPES.TRAINING.VIDEO;
  
  currentMedia.innerHTML = `
    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
      <h4 class="text-sm font-semibold text-gray-600 mb-2">Archivo actual:</h4>
      <div class="p-4 bg-blue-50 text-blue-700 rounded">
        <p>ℹ️ ${isVideo ? 'Video' : 'Imagen'} registrado: ${mediaName}</p>
        <p class="text-sm mt-1">Ruta registrada: ${mediaUrl}</p>
                    <p class="text-sm font-medium text-blue-600 mt-2">
                        Selecciona un nuevo archivo para reemplazar el ${isVideo ? 'video' : 'imagen'} actual
                    </p>
      </div>
    </div>
  `;
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">${type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ'}</span>
                <span class="notification-message">${message}</span>
            </div>
            <button class="notification-close">×</button>
        `;
        
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            document.body.appendChild(container);
        }
        
        container.appendChild(notification);
        
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 300);
        });
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }

    function closeModal() {
        document.querySelectorAll('.modal-overlay').forEach(modal => modal.classList.add('hidden'));
    }

    function closeQuestionModal() {
        document.getElementById('questionModal').classList.add('hidden');
        document.getElementById('questionForm').reset();
        document.getElementById('mediaPreview').classList.add('hidden');
        document.getElementById('contentType').disabled = false;
        state.options = [];
        renderOptions();
    }

    function openAddQuestionModal() {
        const questionModal = document.getElementById('questionModal');
        if (!questionModal) {
            console.error('Modal no encontrado');
            return;
        }

        state.options = [];
        const questionForm = document.getElementById('questionForm');
        if (questionForm) {
            questionForm.reset();
        }

        const mediaPreview = document.getElementById('mediaPreview');
        if (mediaPreview) {
            mediaPreview.classList.add('hidden');
        }
        
        const formModalTitle = document.querySelector('#formModal .modal-title');
        const type = formModalTitle && formModalTitle.textContent.includes('Entrenamiento') ? 'TRAINING' : 'EVALUATION';
        
        const contentTypeSelect = document.getElementById('contentType');
        if (contentTypeSelect) {
            contentTypeSelect.value = type;
            contentTypeSelect.disabled = true;
        }

        if (type === 'EVALUATION') {
            const questionTypeSelect = document.getElementById('questionType');
            if (questionTypeSelect) {
                questionTypeSelect.value = NODE_TYPES.EVALUATION.SINGLE_CHOICE;
                state.options = ['Sí', 'No'];
                renderOptions();
                const optionsContainer = document.getElementById('optionsContainer');
                if (optionsContainer) {
                    optionsContainer.classList.remove('hidden');
                }
        }
        }

        questionModal.classList.remove('hidden');
                toggleContentType();
    }

    function openFormModal(type) {
        const modal = document.getElementById('formModal');
        const modalTitle = document.getElementById('modalTitle');
        const nodes = type === 'TRAINING' ? state.trainingNodes : state.evaluationNodes;
        const addQuestionBtn = document.getElementById('addQuestionBtn');

        modalTitle.textContent = type === 'TRAINING' ? 
            'Gestión de Contenido de Entrenamiento' : 
            'Gestión de Preguntas de Evaluación';

        // Mostrar el botón de agregar si tiene permisos
        if (addQuestionBtn) {
            addQuestionBtn.style.display = 'block';
        }

        renderNodes(nodes, type);
        modal.classList.remove('hidden');
    }

    function validateWeeklyPlan() {
        const textarea = document.getElementById('weeklyPlanTextarea');
        
        if (!textarea) return true;

        // Permitir cualquier contenido, sin restricciones
        return true;
    }

    function setupWeeklyRecipeNode(node) {
        const textarea = document.getElementById('weeklyPlanTextarea');
        const weeklyRecipeContainer = document.getElementById('weeklyRecipeContainer');

        if (weeklyRecipeContainer) {
            weeklyRecipeContainer.classList.remove('hidden');
        }

        if (node.weekly_plan) {
            // Convertir a texto, permitiendo edición completa
            textarea.value = typeof node.weekly_plan === 'object' 
                ? JSON.stringify(node.weekly_plan, null, 2) 
                : String(node.weekly_plan);
        } else {
            // Establecer un valor por defecto editable
            textarea.value = `Escribe tu plan semanal aquí...

Puedes usar texto libre o un formato JSON:
{
    "Lunes": {
        "Desayuno": "Descripción del desayuno",
        "Almuerzo": "Descripción del almuerzo",
        "Cena": "Descripción de la cena"
    }
}`;
        }

        // Asegurar que el textarea sea editable
        textarea.readOnly = false;
        textarea.disabled = false;
    }

    function evaluation_form_button(obj) {
        return `
        <div class="form-row field-evaluation_form">
            <label for="id_evaluation_form">Formulario de Evaluación</label>
            <button type="button" 
                    class="btn btn-primary" 
                    onclick="openFormModal('EVALUATION')">
                Editar Formulario
            </button>
        </div>
        `;
    }

    function training_form_button(obj) {
        return `
        <div class="form-row field-training_form">
            <label for="id_training_form">Formulario de Entrenamiento</label>
            <button type="button" 
                    class="btn btn-primary" 
                    onclick="openFormModal('TRAINING')">
                Editar Formulario
            </button>
        </div>
        `;
    }
  </script>
{% endblock %}
