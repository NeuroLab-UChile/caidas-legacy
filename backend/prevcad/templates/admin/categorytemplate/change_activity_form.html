{% extends "admin/change_form.html" %}
{% load i18n static context %}

{% block extrahead %}
  {{ block.super }}
  <style>
    /* Tu código CSS aquí */
    :root {
      --color-primary: #ffcc00;
      --color-secondary: #333333;
      --color-light: #ffffff;
      --color-dark: #222222;
      --color-danger: #e53e3e;
      --color-danger-hover: #c53030;
      --color-overlay: rgba(0, 0, 0, 0.5);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(6px);
      z-index: 1000;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }

    .modal-content {
      background-color: var(--color-light);
      border-radius: 1rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 600px;
      animation: slideUp 0.4s forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .hidden {
      display: none;
    }

    /* Botón y Formato */
    .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-dark);
    }

    .btn-secondary {
      background-color: var(--color-secondary);
      color: var(--color-light);
    }

    .btn-danger {
      background-color: var(--color-danger);
      color: var(--color-light);
    }
  </style>
{% endblock %}

{% block content %}
  {{ block.super }}

  <!-- Modal Unificado -->
  <div id="formModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 id="modalTitle" class="modal-title">Gestión de Formulario</h2>
      <div id="questionsList">
        <!-- El contenido se llenará dinámicamente via JavaScript -->
      </div>

      <!-- Botones -->
      <div class="flex justify-end gap-2 mt-4">
        <button id="addQuestionBtn" class="btn btn-primary" onclick="openAddQuestionModal()">Agregar Pregunta</button>
        <button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Editar Pregunta -->
  <div id="questionModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="modal-title">Editar Pregunta</h2>
      <form id="questionForm">
        {% csrf_token %}
        <input type="hidden" id="nodeId">

        <div class="form-group">
          <label for="contentType">Tipo de Contenido</label>
          <select id="contentType" class="form-select" required onchange="toggleContentType()">
            <option value="">Seleccione el tipo</option>
            <option value="EVALUATION">Evaluación</option>
            <option value="TRAINING">Entrenamiento</option>
          </select>
        </div>

        <!-- Tipos para Evaluación -->
        <div id="evaluationTypes" class="form-group hidden">
          <label for="questionType">Tipo de Pregunta</label>
          <select id="questionType" class="form-select">
            <option value="MULTIPLE_CHOICE_QUESTION">Selección Múltiple</option>
            <option value="SINGLE_CHOICE_QUESTION">Selección Única</option>
            <option value="SCALE_QUESTION">Escala</option>
            <option value="TEXT_QUESTION">Texto</option>
            <option value="IMAGE_QUESTION">Imagen</option>
          </select>
        </div>

        <!-- Tipos para Entrenamiento -->
        <div id="trainingTypes" class="form-group hidden">
          <label for="trainingType">Tipo de Entrenamiento</label>
          <select id="trainingType" class="form-select">
            <option value="WEEKLY_RECIPE_NODE">Receta Semanal</option>
            <option value="VIDEO_NODE">Video</option>
            <option value="TEXT_NODE">Texto</option>
            <option value="IMAGE_NODE">Imagen</option>
          </select>
        </div>

        <div class="form-group">
          <label for="questionText" id="contentLabel">Pregunta</label>
          <input type="text" id="questionText" class="form-input" required>
        </div>

        <div id="optionsContainer" class="hidden">
          <label>Opciones</label>
          <div class="flex gap-2 mb-2">
            <input type="text" id="newOption" class="form-input" placeholder="Nueva opción">
            <button type="button" id="addOptionBtn" class="btn btn-primary">+</button>
          </div>
          <div id="optionsError" class="text-red-500 text-sm hidden">
            Se requieren al menos 2 opciones para preguntas de selección
          </div>
          <ul id="optionsList" class="mt-2"></ul>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" class="btn btn-secondary" onclick="closeQuestionModal()">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

<script>
  let options = [];
  let mediaFiles = [];

  // Abre el modal de formulario para gestionar preguntas
  function openFormModal(type) {
    const modal = document.getElementById('formModal');
    const modalTitle = document.getElementById('modalTitle');
    modalTitle.textContent = type === 'TRAINING' ? 'Gestión de Contenido de Entrenamiento' : 'Gestión de Evaluación';

    modal.classList.remove('hidden');
    
    // Asegurarnos de obtener los nodos correctos según el tipo y manejar valores nulos
    let nodes;
    if (type === 'TRAINING') {
        nodes = {{ original.training_form.training_nodes|default:"[]"|safe }} || [];
    } else {
        nodes = {{ original.evaluation_form.question_nodes|default:"[]"|safe }} || [];
    }
    
    // Filtrar los nodos según el tipo
    const filteredNodes = nodes.filter(node => {
        if (!node || !node.type) return false;
        return type === 'TRAINING' ? 
            node.type.endsWith('_NODE') : 
            node.type.endsWith('_QUESTION');
    });
    
    console.log(`Abriendo modal de tipo ${type} con nodos filtrados:`, filteredNodes);
    renderNodes(filteredNodes, type);
  }

  // Cierra el modal
  function closeModal() {
    document.querySelectorAll('.modal-overlay').forEach(modal => modal.classList.add('hidden'));
  }

  // Función para manejar el cambio entre tipos de contenido (Evaluación / Entrenamiento)
  function toggleContentType() {
    const contentType = document.getElementById('contentType').value;
    const evaluationTypes = document.getElementById('evaluationTypes');
    const trainingTypes = document.getElementById('trainingTypes');
    const optionsContainer = document.getElementById('optionsContainer');
    const contentLabel = document.getElementById('contentLabel');

    evaluationTypes.classList.toggle('hidden', contentType !== 'EVALUATION');
    trainingTypes.classList.toggle('hidden', contentType !== 'TRAINING');
    
    // Actualizar el label según el tipo
    contentLabel.textContent = contentType === 'TRAINING' ? 'Contenido' : 'Pregunta';
    
    // Mostrar opciones solo para preguntas de selección en evaluación
    const questionType = document.getElementById('questionType').value;
    if (contentType === 'EVALUATION' && ['MULTIPLE_CHOICE_QUESTION', 'SINGLE_CHOICE_QUESTION'].includes(questionType)) {
        optionsContainer.classList.remove('hidden');
    } else {
        optionsContainer.classList.add('hidden');
    }
  }

  // Mostrar el modal de agregar pregunta
  function openAddQuestionModal() {
    options = [];
    renderOptions();
    openModal(questionModal);
  }

  // Mostrar modal
  function openModal(modal) {
    modal.classList.remove('hidden');
  }

  // Cerrar modal de pregunta
  function closeQuestionModal() {
    questionModal.classList.add('hidden');
  }

  // Renderizar las opciones de la pregunta
  function renderOptions() {
    const optionsList = document.getElementById('optionsList');
    optionsList.innerHTML = options.map((opt, index) => `
      <li class="flex items-center gap-2 mb-2">
        <input type="text" value="${opt}" onchange="updateOption(${index}, this.value)" class="form-input">
        <button type="button" onclick="removeOption(${index})" class="text-white px-3 py-2 bg-red-500 rounded-lg font-medium transition-colors">Eliminar</button>
      </li>
    `).join('');
  }

  // Función para agregar una nueva opción
  function addOption() {
    const optionText = document.getElementById('newOption').value.trim();
    if (optionText) {
      options.push(optionText);
      renderOptions();
      document.getElementById('newOption').value = '';
    }
  }

  // Función para actualizar una opción
  function updateOption(index, value) {
    options[index] = value.trim();
  }

  // Función para eliminar una opción
  function removeOption(index) {
    options.splice(index, 1);
    renderOptions();
  }

  // Función para guardar la pregunta o contenido
  function saveQuestion() {
    const contentType = document.getElementById('contentType').value;
    const nodeId = document.getElementById('nodeId').value;
    const questionText = document.getElementById('questionText').value;
    
    // Crear el nodo base
    let nodeData = {
        id: nodeId ? parseInt(nodeId) : Date.now()
    };

    // Preparar los datos según el tipo
    if (contentType === 'TRAINING') {
        nodeData.type = document.getElementById('trainingType').value;
        nodeData.content = questionText;
        
        // Preparar el objeto de formulario para training
        const formData = new FormData();
        formData.append('training_form', JSON.stringify({
            training_nodes: [nodeData]
        }));
        
        // Enviar al endpoint de training
        submitForm(formData, "{% url 'update_training_form' original.id %}");
    } else {
        // Configuración para evaluación
        nodeData.type = document.getElementById('questionType').value;
        nodeData.question = questionText;
        
        // Agregar opciones si es una pregunta de selección
        if (['MULTIPLE_CHOICE_QUESTION', 'SINGLE_CHOICE_QUESTION'].includes(nodeData.type)) {
            if (options.length < 2) {
                document.getElementById('optionsError').classList.remove('hidden');
                return;
            }
            nodeData.options = options;
        }

        // Obtener los nodos existentes
        const existingNodes = {{ original.evaluation_form.question_nodes|default:"[]"|safe }} || [];
        
        // Actualizar o agregar el nuevo nodo
        let updatedNodes;
        if (nodeId) {
            updatedNodes = existingNodes.map(node => 
                node.id === parseInt(nodeId) ? nodeData : node
            );
        } else {
            updatedNodes = [...existingNodes, nodeData];
        }

        // Preparar el objeto de formulario para evaluación
        const formData = new FormData();
        formData.append('evaluation_form', JSON.stringify({
            question_nodes: updatedNodes
        }));

        // Enviar al endpoint de evaluación
        submitForm(formData, "{% url 'update_evaluation_form' original.id %}");
    }
  }

  function submitForm(formData, url) {
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Guardado correctamente');
            location.reload();
        } else {
            throw new Error(data.message || 'Error desconocido');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
    });
  }

  // Renderizar los nodos de preguntas
  function renderNodes(nodes, type) {
    const questionsList = document.getElementById('questionsList');
    
    const evaluationLabels = {
        'MULTIPLE_CHOICE_QUESTION': 'Selección Múltiple',
        'SINGLE_CHOICE_QUESTION': 'Selección Única',
        'SCALE_QUESTION': 'Escala',
        'TEXT_QUESTION': 'Texto',
        'IMAGE_QUESTION': 'Imagen'
    };

    const trainingLabels = {
        'WEEKLY_RECIPE_NODE': 'Receta Semanal',
        'VIDEO_NODE': 'Video',
        'TEXT_NODE': 'Texto',
        'IMAGE_NODE': 'Imagen'
    };

    const typeLabels = type === 'TRAINING' ? trainingLabels : evaluationLabels;

    questionsList.innerHTML = nodes.map((node, index) => {
        const safeNode = JSON.stringify(node).replace(/"/g, '&quot;');
        
        return `
          <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
            <div class="p-6">
              <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                  <span class="text-lg font-semibold">${index + 1}</span>
                  <span class="px-4 py-1 bg-gray-100 rounded-full text-sm font-medium text-gray-600">
                    ${typeLabels[node.type] || node.type}
                  </span>
                </div>
                <div class="flex gap-2 btn-container">
                  <button onclick='editNode(${safeNode}, "${type}")' class="edit-btn btn btn-primary">Editar</button>
                  <button onclick="deleteNode(${node.id}, '${type}')" class="delete-btn btn btn-danger">Eliminar</button>
                </div>
              </div>
              <p class="text-lg mb-4">${type === 'TRAINING' ? node.content : node.question}</p>
              ${(type === 'EVALUATION' && node.options) ? `
                <div class="mt-2">
                  <strong>Opciones:</strong>
                  <ul class="list-disc pl-5">
                    ${node.options.map(opt => `<li>${opt}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          </div>
        `;
    }).join('');
  }

  function editNode(node, type) {
    try {
        // Si el nodo viene como string, parsearlo
        if (typeof node === 'string') {
            node = JSON.parse(node);
        }
        
        const form = document.getElementById('questionForm');
        const contentType = document.getElementById('contentType');
        const nodeId = document.getElementById('nodeId');
        const questionText = document.getElementById('questionText');
        const contentLabel = document.getElementById('contentLabel');
        const optionsContainer = document.getElementById('optionsContainer');
        
        // Limpiar estado previo
        form.reset();
        options = [];
        
        // Establecer tipo de contenido
        contentType.value = type;
        toggleContentType();
        
        // Establecer ID del nodo
        nodeId.value = node.id;
        
        if (type === 'TRAINING') {
            // Configurar campos para entrenamiento
            const trainingType = document.getElementById('trainingType');
            trainingType.value = node.type;
            contentLabel.textContent = 'Contenido';
            questionText.value = node.content;
        } else {
            // Configurar campos para evaluación
            const questionType = document.getElementById('questionType');
            questionType.value = node.type;
            contentLabel.textContent = 'Pregunta';
            questionText.value = node.question;
            
            // Manejar opciones si es pregunta de selección
            if (['MULTIPLE_CHOICE_QUESTION', 'SINGLE_CHOICE_QUESTION'].includes(node.type)) {
                optionsContainer.classList.remove('hidden');
                options = [...(node.options || [])];
                renderOptions();
            }
        }
        
        // Mostrar el modal
        openModal(document.getElementById('questionModal'));
    } catch (error) {
        console.error('Error al editar el nodo:', error);
        alert('Error al editar el elemento');
    }
  }

  // Asegúrate de que el formulario maneje el submit correctamente
  document.getElementById('questionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveQuestion();
  });

  // Asegúrate de que el botón de agregar opción funcione
  document.getElementById('addOptionBtn').addEventListener('click', function() {
    addOption();
  });
</script>
{% endblock %}
