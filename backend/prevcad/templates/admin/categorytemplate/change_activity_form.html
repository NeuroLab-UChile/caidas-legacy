{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block content %}
  {{ block.super }}

  <div class="mt-8 mb-4">
    <h3 class="text-lg font-bold mb-4">Formulario de Evaluación</h3>
    <button id="openViewFormModal" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
      Ver Formulario
    </button>
  </div>

  <!-- Modal: Lista de Preguntas -->
  <div id="viewFormModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-2/3">
      <h2 class="text-lg font-bold mb-4">Preguntas del Formulario</h2>
      
      <div id="questionsList" class="space-y-4 overflow-y-auto max-h-[400px]">
        {% for node in original.evaluation_form.question_nodes %}
          <div class="bg-gray-100 shadow p-4 rounded-lg">
            <div class="flex justify-between items-center">
              <div>
                <span class="text-sm font-semibold">{{ node.type }}</span>
                <p class="text-md">{{ node.question }}</p>
                {% if node.options %}
                  <ul class="list-disc ml-6 mt-2 text-sm">
                    {% for option in node.options %}
                      <li>{{ option|safe }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </div>
              <div class="flex space-x-2">
                <button type="button" onclick="editQuestion({{ node|safe }})"
                  class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Editar</button>
                <button type="button" onclick="deleteQuestion({{ node.id }})"
                  class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Eliminar</button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      
      <!-- Botón Agregar Pregunta -->
      <div class="mt-4">
        <button id="openAddQuestionModal" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
          Agregar Pregunta
        </button>
        <button id="closeViewFormModal" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Formulario Pregunta -->
  <div id="questionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-1/2">
      <h2 id="modalTitle" class="text-lg font-bold mb-4">Agregar Pregunta</h2>
      <form id="questionForm" method="POST">
        {% csrf_token %}
        <input type="hidden" name="node_id" id="nodeId">

        <!-- Tipo -->
        <div class="mb-4">
          <label class="block font-semibold mb-2">Tipo de Pregunta</label>
          <select id="questionType" name="questionType" class="w-full border rounded p-2">
            <option value="MULTIPLE_CHOICE_QUESTION">Múltiple</option>
            <option value="SINGLE_CHOICE_QUESTION">Única</option>
            <option value="SCALE_QUESTION">Escala</option>
          </select>
        </div>

        <!-- Pregunta -->
        <div class="mb-4">
          <label class="block font-semibold mb-2">Pregunta</label>
          <input name="question" id="questionText" type="text" class="w-full border rounded p-2" required>
        </div>

        <!-- Opciones -->
        <div id="optionsContainer" class="hidden">
          <label class="block font-semibold mb-2">Opciones</label>
          <div class="flex mb-2">
            <input type="text" id="newOption" placeholder="Agregar Opción" class="flex-1 border p-2 rounded">
            <button type="button" id="addOptionBtn" class="bg-green-500 text-white px-2 py-1 rounded">+</button>
          </div>
          <ul id="optionsList" class="list-disc ml-6"></ul>
        </div>

        <div class="flex justify-end space-x-2">
          <button type="button" id="closeQuestionModal" class="bg-gray-400 px-4 py-2 rounded">Cancelar</button>
          <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Guardar</button>
        </div>
      </form>
    </div>
  </div>

<script>
  const viewFormModal = document.getElementById('viewFormModal');
  const questionModal = document.getElementById('questionModal');
  const optionsContainer = document.getElementById('optionsContainer');
  let options = [];

  document.getElementById('openViewFormModal').onclick = () => viewFormModal.classList.remove('hidden');
  document.getElementById('closeViewFormModal').onclick = () => viewFormModal.classList.add('hidden');
  
  document.getElementById('openAddQuestionModal').onclick = () => {
    resetQuestionForm();
    questionModal.classList.remove('hidden');
  };
  document.getElementById('closeQuestionModal').onclick = () => questionModal.classList.add('hidden');

  document.getElementById('questionType').onchange = (e) => {
    optionsContainer.classList.toggle('hidden', e.target.value !== 'MULTIPLE_CHOICE_QUESTION' && e.target.value !== 'SINGLE_CHOICE_QUESTION');
  };

  document.getElementById('addOptionBtn').onclick = () => {
    const newOption = document.getElementById('newOption').value.trim();
    if (newOption) {
      options.push(newOption);
      renderOptions();
      document.getElementById('newOption').value = '';
    }
  };

  function renderOptions() {
    const optionsList = document.getElementById('optionsList');
    optionsList.innerHTML = options.map((opt, index) => `
        <li class="flex items-center gap-2 mb-2">
            <input 
                type="text" 
                value="${opt}" 
                onchange="updateOption(${index}, this.value)" 
                class="flex-1 border rounded p-2"
            >
            <button 
                type="button" 
                onclick="removeOption(${index})" 
                class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600"
            >
                Eliminar
            </button>
        </li>
    `).join('');
  }

  function updateOption(index, value) {
    options[index] = value.trim();
    console.log('Updated options:', options); // For debugging
  }

  function removeOption(index) {
    options.splice(index, 1);
    renderOptions();
    console.log('Options after removal:', options); // For debugging
  }

  function resetQuestionForm() {
    document.getElementById('questionForm').reset();
    options = [];
    renderOptions();
  }

  function editQuestion(node) {
    resetQuestionForm();
    document.getElementById('modalTitle').textContent = 'Editar Pregunta';
    document.getElementById('nodeId').value = node.id;
    document.getElementById('questionText').value = node.question;
    document.getElementById('questionType').value = node.type;
    
    // Show options container if it's a multiple choice question
    const isChoiceQuestion = ['MULTIPLE_CHOICE_QUESTION', 'SINGLE_CHOICE_QUESTION'].includes(node.type);
    optionsContainer.classList.toggle('hidden', !isChoiceQuestion);
    
    // Set options and render them
    options = node.options || [];
    renderOptions();
    
    questionModal.classList.remove('hidden');
  }

  function deleteQuestion(nodeId) {
    if (confirm("¿Estás seguro de eliminar esta pregunta?")) {
        const currentForm = {{ original.evaluation_form|safe|default:"{}" }};
        let currentNodes = currentForm.question_nodes || [];
        
        // Filter out the node to delete
        currentNodes = currentNodes.filter(node => node.id !== nodeId);
        
        const updatedForm = {
            question_nodes: currentNodes,
        };

        fetch("{% url 'update_evaluation_form' original.id %}", {
            method: "POST",
            headers: { 
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: new URLSearchParams({
                "evaluation_form": JSON.stringify(updatedForm)
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error: ${response.statusText}`);
            }
            return response.json();
        })
        .then(responseData => {
            if (responseData.status === 'success') {
                alert("Pregunta eliminada correctamente");
                location.reload();
            } else {
                throw new Error(responseData.message || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error("Error al eliminar la pregunta:", error);
            alert(`Error: ${error.message}`);
        });
    }
  }

  function saveQuestion() {
    const questionType = document.getElementById('questionType').value;
    const isChoiceQuestion = ['MULTIPLE_CHOICE_QUESTION', 'SINGLE_CHOICE_QUESTION'].includes(questionType);
    
    if (isChoiceQuestion && (!options || options.length === 0)) {
        alert('Debe agregar al menos una opción para preguntas de selección');
        return;
    }

    const nodeId = document.getElementById('nodeId').value;
    const questionText = document.getElementById('questionText').value;

    const newNode = {
      id: nodeId ? parseInt(nodeId) : Date.now(),
      question: questionText,
      type: questionType,
      options: options
    };

    const currentForm = {{ original.evaluation_form|safe|default:"{}" }};
    let currentNodes = currentForm.question_nodes || [];

    if (nodeId) {
      const index = currentNodes.findIndex(node => node.id === parseInt(nodeId));
      if (index !== -1) {
        currentNodes[index] = newNode;
      } else {
        currentNodes.push(newNode);
      }
    } else {
      currentNodes.push(newNode);
    }

    const updatedForm = {
      question_nodes: currentNodes,
    };

    fetch("{% url 'update_evaluation_form' original.id %}", {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
      body: new URLSearchParams({ "evaluation_form": JSON.stringify(updatedForm) })
    }).then(response => {
      if (!response.ok) {
        throw new Error(`Error: ${response.statusText}`);
      }
      return response.json();
    }).then(responseData => {
      if (responseData.status === 'success') {
        alert("Formulario actualizado correctamente");
        location.reload();
      } else {
        throw new Error(responseData.message || 'Error desconocido');
      }
    }).catch(error => {
      console.error("Error al guardar el formulario:", error);
      alert(`Error: ${error.message}`);
    });
  }

  document.getElementById('questionForm').onsubmit = function(e) {
    e.preventDefault();
    saveQuestion();
  };
</script>
{% endblock %}
